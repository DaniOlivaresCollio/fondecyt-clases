# Procesamiento Data Conclat

```{r,echo=FALSE,warning=FALSE,message=FALSE}
rm(list=ls())
options(scipen = 999)

library(pacman)
p_load(bookdown,
       car,
       ggalluvial,
       ggplot2,
       ggrepel,
       gridExtra,
       kableExtra,
       knitr,
       labelled,
       lubridate,
       psych,
       readr,
       readxl,
       shadowtext,
       sjmisc,
       sjPlot,
       sjlabelled,
       statar,
       stringr,
       survey,
       tidyverse,
       tinytex,
       viridis,
       httr
       )
```

## Cargar datos

```{r datos,message=FALSE,warning=FALSE}
load("input/data/datos-conclat.Rdata")
data_raw <- data
```

## Variables

```{r data,message=FALSE,warning=FALSE}
data <- data %>% 
  select(id,
         rake_wb2,
         # Relación con los medios de producción
         a07,
         a26,
         a27,
         # Skills
         a02,a02_rec,a03,a03_rec,ciuo08,
         e05,
         # Autoridad / orgnización
         a15,
         a16,
         a17_01,a17_02,a17_03,a17_04,a17_05,a17_06)# %>% 
  #sjlabelled::set_na(.,na=c(-999,-888,-777))
```

## Procesamiento

### relation_mop

```{r}
# Situación empleo
data <- data %>%
  mutate(
    a07 = factor(
      as.numeric(a07),
      levels = 1:9,
      labels = c(
        "1. Patrón(a) o empleador(a)",
        "2. Trabajador(a) por cuenta propia",
        "3. Empleado(a) u obrero(a) del sector público (Gobierno Central o Municipal)",
        "4. Empleado(a) u obrero(a) de empresas públicas",
        "5. Empleado(a) u obrero(a) del sector privado",
        "6. Servicio doméstico puertas adentro",
        "7. Servicio doméstico puertas afuera",
        "8. FF.AA. y del Orden",
        "9. Familiar no remunerado"
      )
    )
  ) %>%
  set_variable_labels(a07 = "Employment situation (a07)")

frq(data$a07)

data <- data %>%
  mutate(
    relation_mop = case_when(
      as_numeric(a07) == 1 ~ 1,
      as_numeric(a07) == 2 ~ 2,
      as_numeric(a07) >= 3 ~ 3,
      TRUE ~ NA_real_
      ),
    relation_mop = factor(
      relation_mop,
      levels = 1:3,
      labels = c(
        "1. Employers",
        "2. Self-Employed",
        "3. Salaried"
      )
    )
  ) %>%
  set_variable_labels(relation_mop = "Relation with Means of Production")

frq(data$relation_mop)
```

### company_size

```{r}
frq(data$a26)

data <- data %>%
  mutate(
    company_size = case_when(
      a26 %in% c(1) ~ 1,
      a26 %in% c(2, 3) ~ 2,
      a26 %in% c(4, 5) ~ 3,
      a26 %in% c(6, 7) ~ 4,
      a26 %in% c(8, 9) ~ 5,
      TRUE ~ NA_real_
    ),
    company_size = factor(
      company_size, 
      levels = 1:5, 
      labels = c(
        "Solo",
        "2-9",
        "10-49",
        "50-199",
        "200 or more"),
      ordered = TRUE
    )
  ) %>%
  set_variable_labels(company_size = "Company Size")

frq(data$company_size)
```

### workplace_size

```{r}
frq(data$a27)

data <- data %>%
  mutate(
    workplace_size = case_when(
      a27 %in% c(1) ~ 1,
      a27 %in% c(2, 3) ~ 2,
      a27 %in% c(4, 5) ~ 3,
      a27 %in% c(6, 7) ~ 4,
      a27 %in% c(8, 9) ~ 5,
      TRUE ~ NA_real_
    ),
    workplace_size = factor(
      workplace_size, 
      levels = 1:5, 
      labels = c(
        "Solo",
        "2-9",
        "10-49",
        "50-199",
        "200 or more"),
      ordered = TRUE
    )
  ) %>%
  set_variable_labels(workplace_size = "Workplace Size")

frq(data$workplace_size)
```

### owners

```{r}
table(data$relation_mop,data$company_size)
table(data$relation_mop,data$workplace_size)

data <- data %>%
  mutate(
    owners = case_when(
      as.numeric(relation_mop) %in% 1:2 &
        (as.numeric(company_size) == 1 | 
         (is.na(company_size) & as.numeric(workplace_size) == 1)) ~ 1,
      as.numeric(relation_mop) %in% 1:2 &
        (as.numeric(company_size) == 2 | 
         (is.na(company_size) & as.numeric(workplace_size) == 2)) ~ 2,
      as.numeric(relation_mop) %in% 1:2 &
        (as.numeric(company_size) >= 3 |
         (is.na(company_size) & as.numeric(workplace_size) >= 3)) ~ 3,
      TRUE ~ NA_real_
    ),
    owners = factor(
      owners,
      levels = 1:3,
      labels = c(
        "1. Solo Self-Employed",
        "2. Small employers",
        "3. Employers"
      )
    )
  ) %>%
  set_variable_labels(owners = "Owners")

frq(data$owners)
```

### educ

```{r}
frq(data$e05)

data <- data %>%
  mutate(
    educ = ifelse(e05 %in% c(-999, -888), NA, e05)
  ) %>%
  set_variable_labels(educ = "Educational level")

frq(data$educ)
```

### isco08_2d

```{r}
# frq(data$ciuo08)

data %>%
  filter(as.numeric(ciuo08) < 1100) %>%
  select(ciuo08, a03)

data <- data %>%
  mutate(
    isco08_2d = as.numeric(substr(ciuo08, 1, 2)),
    isco08_2d = ifelse(isco08_2d %in% c(-9, 1), NA, isco08_2d)
  ) %>%
  set_variable_labels(isco08_2d = "ISCO-08: 2 digits")

frq(data$isco08_2d)
```

### skills

- Experts -> ciuo08_2d == 11 a 34 con universitaria completa o más (educ >= 9)
- Skilled -> ciuo08_2d == 11 a 34 con universitaria incompleta o menos (educ < 9), y
- Skilled -> ciuo08_2d == 35,41,42,43,44,53, y 
- Skilled -> ciuo08_2d == 51,54,61,62,71,72,73,74,75,81 con media completa o más (educ >= 5).
- Unskilled -> ciuo08_2d == 51,54,61,62,71,72,73,74,75,81 con media incompleta o menos, y 
- Unskilled -> ciuo08_2d == 52,63,82,83,90+

Falta clasificar: 36, 52, 55 !!!!

```{r}
data <- data %>% 
  mutate(
    skills = case_when(
      isco08_2d <= 34 & educ >= 9 ~ 1,
      isco08_2d <= 34 & educ < 9 ~ 2,
      isco08_2d %in% c(35,41:44,53) ~ 2,
      isco08_2d %in% c(51,54,61,62,71:75,81) & educ > 5 ~ 2,
      isco08_2d %in% c(51,54,61,62,71:75,81) & educ <= 5 ~ 3,
      isco08_2d %in% c(52,63,82,83,91:99) ~ 3
    ),
    skills = factor(
      skills, 
      levels = 1:3,
      labels = c(
        "1. Experts",
        "2. Skilled",
        "3. Unskilled"
      )
    )
  ) %>%
  set_variable_labels(skills = "Skills")

frq(data$skills)
```

### formal_position_auth

```{r}
frq(data$a15)

data <- data %>%
  mutate(
    formal_position_auth = case_when(
      as.numeric(relation_mop) %in% c(1, 2) ~ NA_real_,
      TRUE ~ as.numeric(a15)
    ),
    formal_position_auth = factor(
      formal_position_auth,
      levels = 1:4,
      labels = c(
        "1. Senior manager or executive",
        "2. Middle manager (e.g., sector, office or branch head)",
        "3. Supervisor or foreperson",
        "4. Regular employee or worker (no supervisory role)"
      )
    )
  ) %>%
  set_variable_labels(formal_position_auth = "Formal position of authority (a15)")

frq(data$formal_position_auth)
```

### supervision

```{r}
frq(data$a16)

data <- data %>%
  mutate(
    supervision = case_when(
      a16 == 1 ~ 1,
      a16 %in% c(2, -888, -999) ~ 0,
      TRUE ~ NA_real_
    )
  ) %>%
  set_variable_labels(supervision = "Supervises other workers (a16)")

frq(data$supervision)
```

### decisionmaking_influence

```{r}
frq(data$a17_01)
frq(data$a17_02)
frq(data$a17_03)
frq(data$a17_04)
frq(data$a17_05)
frq(data$a17_06)

data <- data %>%
  mutate(
    decisionmaking_influence = if_else(
      is.na(a17_01),
      NA_real_,
      rowSums(across(a17_01:a17_06, ~ case_when(
        .x == 1 ~ 3,
        .x == 2 ~ 2,
        .x == 3 ~ 1,
        .x %in% c(-888, -999) ~ 1,  
        TRUE ~ NA_real_
      )), na.rm = TRUE)
    ),
    decisionmaking_influence_mean = if_else(
      is.na(a17_01),
      NA_real_,
      rowMeans(across(a17_01:a17_06, ~ case_when(
        .x == 1 ~ 3,
        .x == 2 ~ 2,
        .x == 3 ~ 1,
        .x %in% c(-888, -999) ~ 1,
        TRUE ~ NA_real_
      )), na.rm = TRUE)
    )
  ) %>%
  set_variable_labels(
    decisionmaking_influence = "Decision-making influence (sum, inverted)",
    decisionmaking_influence_mean = "Decision-making influence (mean, inverted)"
  )

frq(data$decisionmaking_influence)
frq(data$decisionmaking_influence_mean)
```

## Descriptivos

```{r}
table(data$formal_position_auth, data$decisionmaking_influence)
table(data$formal_position_auth, data$decisionmaking_influence_mean)
```

